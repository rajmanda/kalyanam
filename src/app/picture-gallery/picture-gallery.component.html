<div class="gallery-container" data-testid="picture-gallery-root">
  <!-- Header with title and upload button -->
  <div class="gallery-header">
    <h2>Photo Gallery</h2>
    <div class="upload-section" data-testid="gallery-upload-section">
      <button mat-raised-button color="primary" (click)="triggerFileInput()" [disabled]="isUploading" data-testid="gallery-upload-button">
        <mat-icon>cloud_upload</mat-icon> Upload Photos (Max {{fileLimit}})
      </button>
      <input
        type="file"
        id="fileInput"
        style="display: none"
        accept="image/*,video/*"
        multiple
        (change)="onFileSelected($event)"
        data-testid="gallery-file-input"
      >

      <!-- Selected files preview -->
      <div *ngIf="selectedFiles.length > 0" class="selected-files" data-testid="gallery-selected-files">
        <h4>Selected Files ({{selectedFiles.length}}/{{fileLimit}}):</h4>
        <div class="file-list">
          <div *ngFor="let file of selectedFiles" class="file-item" data-testid="gallery-selected-file-item">
            <mat-icon>image</mat-icon>
            <div class="file-details">
              <div class="file-name">{{file.name}}</div>
              <div class="file-size">{{file.size | fileSize}}</div>
            </div>
          </div>
        </div>
        <div class="upload-actions">
          <button mat-button (click)="selectedFiles = []" [disabled]="isUploading" data-testid="gallery-clear-selection-button">
            <mat-icon>clear</mat-icon> Clear Selection
          </button>
          <button mat-raised-button color="primary" (click)="uploadImages()" [disabled]="isUploading" data-testid="gallery-upload-start-button">
            <mat-icon>cloud_upload</mat-icon> Upload {{selectedFiles.length}} File{{selectedFiles.length === 1 ? '' : 's'}}
          </button>
        </div>
      </div>

      <!-- Upload progress -->
      <div *ngIf="isUploading" class="upload-progress" data-testid="gallery-upload-progress">
        <mat-progress-bar mode="determinate" [value]="uploadProgress"></mat-progress-bar>
        <div class="progress-text">Uploading: {{uploadProgress}}%</div>
      </div>

      <!-- Error messages -->
      <div *ngIf="uploadErrors.length > 0" class="error-message" data-testid="gallery-upload-errors">
        <mat-icon>error_outline</mat-icon>
        <div>
          <div *ngFor="let error of uploadErrors">{{error}}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Error message -->
  <div *ngIf="errorMessage" class="error-message" data-testid="gallery-error-message">
    <mat-icon>error_outline</mat-icon>
    <span>{{ errorMessage }}</span>
  </div>

  <!-- View tabs -->
  <mat-tab-group (selectedTabChange)="onTabChange($event)" data-testid="gallery-tabs">
    <mat-tab label="All Photos">
      <ng-template mat-tab-label>
        <mat-icon class="tab-icon">photo_library</mat-icon>
        All Photos
      </ng-template>
      <div *ngIf="isLoading; else galleryContent" class="loading-message" data-testid="gallery-loading-all">
        <mat-spinner></mat-spinner>
        <p>Loading images...</p>
      </div>
      <ng-template #galleryContent>
        <div class="picture-grid">
          <div *ngFor="let image of filteredImages" class="picture-item" (click)="onImageClick(image)" data-testid="gallery-picture-item">
            <div class="picture-image-container">
              <img [src]="image.url" loading="lazy" [alt]="'Media uploaded by ' + (image.uploadedBy || 'unknown user')" class="picture-image" />
              <div *ngIf="isVideoUrl(image.url)" class="video-overlay">
                <div class="play-button">
                  <mat-icon>play_circle_filled</mat-icon>
                </div>
              </div>
            </div>
            <div class="picture-meta">
              <span class="uploader" *ngIf="image.uploadedBy">
                <mat-icon>person</mat-icon> {{ image.uploadedBy }}
              </span>
              <span class="date" *ngIf="image.uploadedAt">
                <mat-icon>schedule</mat-icon> {{ image.uploadedAt | date:'medium' }}
              </span>
            </div>
          </div>
          <div *ngIf="filteredImages.length === 0" class="empty-state" data-testid="gallery-empty-all">
            <mat-icon>photo_library</mat-icon>
            <p>No photos found. Be the first to upload one!</p>
          </div>
        </div>
      </ng-template>
    </mat-tab>

    <mat-tab label="My Photos">
      <ng-template mat-tab-label>
        <mat-icon class="tab-icon">person</mat-icon>
        My Photos
      </ng-template>
      <div *ngIf="isLoading; else myPhotosContent" class="loading-message" data-testid="gallery-loading-mine">
        <mat-spinner></mat-spinner>
        <p>Loading your photos...</p>
      </div>
      <ng-template #myPhotosContent>
        <div class="picture-grid">
          <div *ngFor="let image of filteredImages" class="picture-item" (click)="onImageClick(image)" data-testid="gallery-picture-item">
            <div class="picture-image-container">
              <img [src]="image.url" loading="lazy" [alt]="'Media uploaded by ' + (image.uploadedBy || 'unknown user')" class="picture-image" />
              <div *ngIf="isVideoUrl(image.url)" class="video-overlay">
                <div class="play-button">
                  <mat-icon>play_circle_filled</mat-icon>
                </div>
              </div>
            </div>
            <div class="picture-meta">
              <span class="date">
                <mat-icon>schedule</mat-icon> {{ image.uploadedAt | date:'medium' }}
              </span>
            </div>
          </div>
          <div *ngIf="filteredImages.length === 0" class="empty-state" data-testid="gallery-empty-mine">
            <mat-icon>add_a_photo</mat-icon>
            <p>You haven't uploaded any photos yet. Click the upload button to get started!</p>
          </div>
        </div>
      </ng-template>
    </mat-tab>
  </mat-tab-group>
</div>
